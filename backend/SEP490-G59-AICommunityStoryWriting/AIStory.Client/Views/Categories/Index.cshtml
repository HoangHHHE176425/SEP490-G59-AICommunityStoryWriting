@{
    ViewData["Title"] = "Quản lý Thể loại";
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-tags"></i> Quản lý Thể loại</h2>
                <button class="btn btn-primary" onclick="showCreateCategoryModal()">
                    <i class="bi bi-plus-circle"></i> Tạo thể loại mới
                </button>
            </div>

            <!-- Filter -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Tìm kiếm</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Tên, mô tả, slug..." onkeyup="debounceSearch()">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select" id="statusFilter" onchange="loadCategories()">
                                <option value="">Tất cả</option>
                                <option value="true">Hoạt động</option>
                                <option value="false">Không hoạt động</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Loại</label>
                            <select class="form-select" id="viewMode" onchange="loadCategories()">
                                <option value="">Tất cả</option>
                                <option value="roots">Chỉ loại gốc</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Sắp xếp</label>
                            <select class="form-select" id="sortBy" onchange="loadCategories()">
                                <option value="name">Tên</option>
                                <option value="created_at">Ngày tạo</option>
                                <option value="story_count">Số truyện</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Thứ tự</label>
                            <select class="form-select" id="sortOrder" onchange="loadCategories()">
                                <option value="asc">Tăng dần</option>
                                <option value="desc">Giảm dần</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Số trang</label>
                            <select class="form-select" id="pageSize" onchange="loadCategories()">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories Table -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="text-muted">Tổng số: <strong id="totalCount">0</strong></span>
                        </div>
                        <div>
                            <span class="text-muted">Trang <strong id="currentPage">1</strong> / <strong id="totalPages">1</strong></span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tên</th>
                                    <th>Thuộc loại</th>
                                    <th>Slug</th>
                                    <th>Mô tả</th>
                                    <th>Số truyện</th>
                                    <th>Trạng thái</th>
                                    <th>Ngày tạo</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesTableBody">
                                <tr>
                                    <td colspan="9" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    <nav id="paginationNav" class="mt-3"></nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">Tạo thể loại mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                    <div class="mb-3">
                        <label for="categoryParentId" class="form-label">Thuộc loại cha</label>
                        <select class="form-select" id="categoryParentId">
                            <option value="">— Loại truyện (gốc) —</option>
                        </select>
                        <small class="form-text text-muted">Để trống = Loại truyện (Truyện ngắn, Truyện dài...). Chọn một = Thể loại con (A, B, C...).</small>
                    </div>
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Tên thể loại <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="categoryIconImage" class="form-label">Icon / Ảnh thể loại</label>
                        <input type="file" class="form-control" id="categoryIconImage" accept="image/*" onchange="previewCategoryIcon(this)">
                        <small class="form-text text-muted">Jpg, png, gif, webp, svg — tối đa 2MB</small>
                        <div id="categoryIconPreview" class="mt-2"></div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="categoryIsActive" checked>
                            <label class="form-check-label" for="categoryIsActive">
                                Đang hoạt động
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">Lưu</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let categories = [];
        let editingCategoryId = null;
        let currentPage = 1;
        let totalPages = 1;
        let totalCount = 0;
        let searchTimeout = null;

        // Load categories on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
        });

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1; // Reset to first page on new search
                loadCategories();
            }, 500);
        }

        async function loadCategories(page = 1) {
            try {
                currentPage = page;
                const search = document.getElementById('searchInput').value.trim();
                const statusFilter = document.getElementById('statusFilter').value;
                const viewMode = document.getElementById('viewMode').value;
                const sortBy = document.getElementById('sortBy').value;
                const sortOrder = document.getElementById('sortOrder').value;
                const pageSize = parseInt(document.getElementById('pageSize').value);

                // Always use pagination API for better performance and features
                const query = {
                    page: page,
                    pageSize: pageSize,
                    search: search || null,
                    isActive: statusFilter ? (statusFilter === 'true') : null,
                    rootsOnly: viewMode === 'roots' ? true : null,
                    sortBy: sortBy,
                    sortOrder: sortOrder
                };

                const result = await ApiService.getCategoriesWithPagination(query);
                categories = result.items || [];
                totalCount = result.totalCount || 0;
                totalPages = result.totalPages || 1;
                
                // Update pagination info
                document.getElementById('totalCount').textContent = totalCount;
                document.getElementById('currentPage').textContent = currentPage;
                document.getElementById('totalPages').textContent = totalPages;
                
                renderCategories();
                renderPagination();
            } catch (error) {
                Utils.showAlert('Lỗi khi tải danh sách thể loại: ' + error.message, 'danger');
            }
        }

        function renderCategories() {
            const tbody = document.getElementById('categoriesTableBody');

            if (categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Không có dữ liệu</td></tr>';
                return;
            }

            // Render flat list (pagination mode)
            tbody.innerHTML = categories.map(cat => categoryRow(cat, false)).join('');
        }

        function renderPagination() {
            const nav = document.getElementById('paginationNav');
            if (totalPages <= 1) {
                nav.innerHTML = '';
                return;
            }

            let pagination = '<ul class="pagination justify-content-center">';

            // Previous button
            pagination += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadCategories(${currentPage - 1}); return false;">Trước</a>
            </li>`;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    pagination += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadCategories(${i}); return false;">${i}</a>
                    </li>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    pagination += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // Next button
            pagination += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadCategories(${currentPage + 1}); return false;">Sau</a>
            </li>`;

            pagination += '</ul>';
            nav.innerHTML = pagination;
        }

        function categoryRow(cat, isChild) {
            const indent = isChild ? '<span class="ms-3 text-muted">↳</span> ' : '';
            return `
                <tr>
                    <td>${cat.id}</td>
                    <td>
                        ${indent}
                        ${cat.iconUrl ? `<img src="http://localhost:5000${cat.iconUrl}" alt="${cat.name}" class="rounded" style="width:32px;height:32px;object-fit:cover;">` : '<i class="bi bi-tag text-muted"></i>'}
                        <strong class="ms-2">${cat.name}</strong>
                    </td>
                    <td>${cat.parentName || '<em>Loại truyện (gốc)</em>'}</td>
                    <td><code>${cat.slug}</code></td>
                    <td>${cat.description || '-'}</td>
                    <td><span class="badge bg-info">${cat.storyCount || 0}</span></td>
                    <td>
                        <span class="badge ${cat.isActive ? 'bg-success' : 'bg-secondary'}">
                            ${cat.isActive ? 'Hoạt động' : 'Không hoạt động'}
                        </span>
                    </td>
                    <td>${Utils.formatDate(cat.createdAt)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editCategory('${cat.id}')" title="Sửa">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="toggleCategoryActive('${cat.id}')" title="Bật/Tắt">
                            <i class="bi bi-toggle-${cat.isActive ? 'on' : 'off'}"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat.id}')" title="Xóa">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
        }

        async function showCreateCategoryModal() {
            editingCategoryId = null;
            document.getElementById('categoryModalTitle').textContent = 'Tạo thể loại mới';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryIsActive').checked = true;
            document.getElementById('categoryIconPreview').innerHTML = '';
            document.getElementById('categoryIconImage').value = '';
            await loadParentDropdown();
            new bootstrap.Modal(document.getElementById('categoryModal')).show();
        }

        async function loadParentDropdown() {
            const roots = await ApiService.getCategories(true, null, true);
            const sel = document.getElementById('categoryParentId');
            sel.innerHTML = '<option value="">— Loại truyện (gốc) —</option>' +
                roots.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
        }

        async function editCategory(id) {
            try {
                await loadParentDropdown();
                const category = await ApiService.getCategoryById(id);
                editingCategoryId = id;
                document.getElementById('categoryModalTitle').textContent = 'Sửa thể loại';
                document.getElementById('categoryId').value = category.id;
                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryDescription').value = category.description || '';
                document.getElementById('categoryIsActive').checked = category.isActive;
                document.getElementById('categoryParentId').value = category.parentId ?? '';
                document.getElementById('categoryIconImage').value = '';
                if (category.iconUrl) {
                    document.getElementById('categoryIconPreview').innerHTML =
                        `<img src="http://localhost:5000${category.iconUrl}" class="img-thumbnail" style="max-height:80px;">
                         <p class="text-muted mt-1 small">Ảnh hiện tại. Chọn ảnh mới để thay thế.</p>`;
                } else {
                    document.getElementById('categoryIconPreview').innerHTML = '';
                }
                new bootstrap.Modal(document.getElementById('categoryModal')).show();
            } catch (error) {
                Utils.showAlert('Lỗi khi tải thông tin thể loại: ' + error.message, 'danger');
            }
        }

        function previewCategoryIcon(input) {
            const preview = document.getElementById('categoryIconPreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="img-thumbnail" style="max-height:80px;">`;
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.innerHTML = '';
            }
        }

        async function saveCategory() {
            const form = document.getElementById('categoryForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            try {
                const formData = new FormData();
                formData.append('Name', document.getElementById('categoryName').value);
                formData.append('Description', document.getElementById('categoryDescription').value);
                formData.append('IsActive', document.getElementById('categoryIsActive').checked);

                const parentId = document.getElementById('categoryParentId').value;
                if (parentId) formData.append('ParentId', parentId);

                const iconFile = document.getElementById('categoryIconImage').files[0];
                if (iconFile) {
                    formData.append('IconImage', iconFile);
                }

                if (editingCategoryId) {
                    await ApiService.updateCategory(editingCategoryId, formData);
                    Utils.showAlert('Cập nhật thể loại thành công!', 'success');
                } else {
                    await ApiService.createCategory(formData);
                    Utils.showAlert('Tạo thể loại thành công!', 'success');
                }

                bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
                loadCategories(currentPage);
            } catch (error) {
                Utils.showAlert('Lỗi: ' + error.message, 'danger');
            }
        }

        async function deleteCategory(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa thể loại này?')) return;

            try {
                await ApiService.deleteCategory(id);
                Utils.showAlert('Xóa thể loại thành công!', 'success');
                loadCategories(currentPage);
            } catch (error) {
                Utils.showAlert('Lỗi: ' + error.message, 'danger');
            }
        }

        async function toggleCategoryActive(id) {
            try {
                await ApiService.toggleCategoryActive(id);
                Utils.showAlert('Cập nhật trạng thái thành công!', 'success');
                loadCategories(currentPage);
            } catch (error) {
                Utils.showAlert('Lỗi: ' + error.message, 'danger');
            }
        }
    </script>
}
