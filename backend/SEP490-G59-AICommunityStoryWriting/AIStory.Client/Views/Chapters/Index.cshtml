@{
    ViewData["Title"] = "Quản lý Chapters";
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-list-ol"></i> Quản lý Chapters</h2>
            </div>

            <!-- Filters -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Story (chọn từ danh sách của bạn)</label>
                            <select class="form-select" id="storyIdFilter" onchange="loadChapters()">
                                <option value="">Tất cả stories của tôi</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select" id="statusFilter" onchange="loadChapters()">
                                <option value="">Tất cả</option>
                                <option value="DRAFT">Draft</option>
                                <option value="PENDING_REVIEW">Pending Review</option>
                                <option value="REJECTED">Rejected</option>
                                <option value="PUBLISHED">Published</option>
                                <option value="HIDDEN">Hidden</option>
                                <option value="ARCHIVED">Archived</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Loại truy cập</label>
                            <select class="form-select" id="accessTypeFilter" onchange="loadChapters()">
                                <option value="">Tất cả</option>
                                <option value="FREE">Miễn phí</option>
                                <option value="PAID">Trả phí</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Sắp xếp</label>
                            <select class="form-select" id="sortBy" onchange="loadChapters()">
                                <option value="order_index">Thứ tự</option>
                                <option value="created_at">Ngày tạo</option>
                                <option value="published_at">Ngày publish</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Thứ tự</label>
                            <select class="form-select" id="sortOrder" onchange="loadChapters()">
                                <option value="asc">Tăng dần</option>
                                <option value="desc">Giảm dần</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Số trang</label>
                            <select class="form-select" id="pageSize" onchange="loadChapters()">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chapters Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Story ID</th>
                                    <th>Tiêu đề</th>
                                    <th>Thứ tự</th>
                                    <th>Số từ</th>
                                    <th>Trạng thái</th>
                                    <th>Loại truy cập</th>
                                    <th>Giá</th>
                                    <th>Ngày tạo</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="chaptersTableBody">
                                <tr>
                                    <td colspan="10" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <nav id="paginationNav" class="mt-4"></nav>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let chapters = [];
        let currentPage = 1;
        let totalPages = 1;

        document.addEventListener('DOMContentLoaded', function() {
            // Kiểm tra authentication và role
            if (!AuthHelper.isAuthenticated()) {
                Utils.showAlert('Vui lòng đăng nhập để truy cập trang này.', 'warning');
                setTimeout(() => {
                    window.location.href = '/Auth/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
                }, 1500);
                return;
            }

            // Kiểm tra role AUTHOR
            if (!AuthHelper.isAuthor()) {
                Utils.showAlert('Bạn không có quyền truy cập trang này. Chỉ AUTHOR mới được quản lý stories và chapters.', 'danger');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return;
            }

            // Load user info và cập nhật UI
            AuthHelper.loadUserInfo().then(() => {
                loadAuthorStories();
                loadChapters();
            });
        });

        // Load danh sách stories của author để hiển thị trong dropdown
        async function loadAuthorStories() {
            try {
                const authorId = AuthHelper.getAuthorId();
                if (!authorId) return;

                const storiesQuery = {
                    page: 1,
                    pageSize: 1000, // Lấy tất cả stories
                    authorId: authorId
                };
                const storiesResult = await ApiService.getStories(storiesQuery);
                const stories = storiesResult.items;

                const storySelect = document.getElementById('storyIdFilter');
                storySelect.innerHTML = '<option value="">Tất cả stories của tôi</option>';
                stories.forEach(story => {
                    const option = document.createElement('option');
                    option.value = story.id;
                    option.textContent = `${story.title} (${story.totalChapters || 0} chapters)`;
                    storySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading author stories:', error);
            }
        }

        async function loadChapters(page = 1) {
            try {
                currentPage = page;

                // Lấy AuthorId từ token
                const authorId = AuthHelper.getAuthorId();
                if (!authorId) {
                    Utils.showAlert('Không thể lấy thông tin author. Vui lòng đăng nhập lại.', 'warning');
                    return;
                }

                // Lấy danh sách stories của author hiện tại
                const storiesQuery = {
                    page: 1,
                    pageSize: 1000, // Lấy tất cả stories của author
                    authorId: authorId
                };
                const storiesResult = await ApiService.getStories(storiesQuery);
                const authorStoryIds = storiesResult.items.map(s => s.id);

                if (authorStoryIds.length === 0) {
                    chapters = [];
                    totalPages = 0;
                    renderChapters();
                    renderPagination();
                    return;
                }

                // Nếu có filter storyId từ dropdown, kiểm tra story đó có thuộc về author không
                const storyIdFilter = document.getElementById('storyIdFilter').value;
                let storyId = null;
                if (storyIdFilter) {
                    if (authorStoryIds.includes(storyIdFilter)) {
                        storyId = storyIdFilter;
                    } else {
                        Utils.showAlert('Story không thuộc về bạn.', 'warning');
                        document.getElementById('storyIdFilter').value = '';
                        return;
                    }
                }

                const query = {
                    page: page,
                    pageSize: parseInt(document.getElementById('pageSize').value),
                    storyId: storyId,
                    status: document.getElementById('statusFilter').value || null,
                    accessType: document.getElementById('accessTypeFilter').value || null,
                    sortBy: document.getElementById('sortBy').value,
                    sortOrder: document.getElementById('sortOrder').value
                };

                // Nếu không có storyId filter, chỉ lấy chapters của stories thuộc về author
                // (API sẽ filter theo storyId, nhưng nếu không có storyId thì sẽ lấy tất cả)
                // Vì vậy, nếu không có storyId, chúng ta cần load chapters của từng story và merge
                if (!storyId) {
                    // Load chapters của tất cả stories của author
                    const allChapters = [];
                    for (const sid of authorStoryIds) {
                        try {
                            const chaptersForStory = await ApiService.getChaptersByStoryId(sid);
                            allChapters.push(...chaptersForStory);
                        } catch (error) {
                            console.error(`Error loading chapters for story ${sid}:`, error);
                        }
                    }

                    // Apply filters
                    let filteredChapters = allChapters;
                    const statusFilter = document.getElementById('statusFilter').value;
                    if (statusFilter) {
                        filteredChapters = filteredChapters.filter(c => c.status === statusFilter);
                    }
                    const accessTypeFilter = document.getElementById('accessTypeFilter').value;
                    if (accessTypeFilter) {
                        filteredChapters = filteredChapters.filter(c => c.accessType === accessTypeFilter);
                    }

                    // Sort
                    const sortBy = document.getElementById('sortBy').value;
                    const sortOrder = document.getElementById('sortOrder').value;
                    filteredChapters.sort((a, b) => {
                        let aVal, bVal;
                        switch (sortBy) {
                            case 'created_at':
                                aVal = new Date(a.createdAt || 0);
                                bVal = new Date(b.createdAt || 0);
                                break;
                            case 'published_at':
                                aVal = new Date(a.publishedAt || 0);
                                bVal = new Date(b.publishedAt || 0);
                                break;
                            default:
                                aVal = a.orderIndex || 0;
                                bVal = b.orderIndex || 0;
                        }
                        return sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
                    });

                    // Pagination
                    const pageSize = parseInt(document.getElementById('pageSize').value);
                    const startIndex = (page - 1) * pageSize;
                    chapters = filteredChapters.slice(startIndex, startIndex + pageSize);
                    totalPages = Math.ceil(filteredChapters.length / pageSize);
                } else {
                    // Có storyId filter, dùng API bình thường
                    const result = await ApiService.getChapters(query);
                    chapters = result.items;
                    totalPages = result.totalPages;
                }

                renderChapters();
                renderPagination();
            } catch (error) {
                Utils.showAlert('Lỗi khi tải danh sách chapters: ' + error.message, 'danger');
            }
        }

        function renderChapters() {
            const tbody = document.getElementById('chaptersTableBody');
            if (chapters.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">Không có dữ liệu</td></tr>';
                return;
            }

            tbody.innerHTML = chapters.map(chapter => `
                <tr>
                    <td>${chapter.id}</td>
                    <td>
                        <a href="/Stories/Details/${chapter.storyId}" class="text-decoration-none">
                            ${chapter.storyId}
                        </a>
                    </td>
                    <td><strong>${chapter.title}</strong></td>
                    <td><span class="badge bg-secondary">${chapter.orderIndex}</span></td>
                    <td>${Utils.formatNumber(chapter.wordCount || 0)}</td>
                    <td>
                        <span class="badge ${chapter.status === 'PUBLISHED' ? 'bg-success' : 'bg-secondary'}">
                            ${chapter.status || 'DRAFT'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${chapter.accessType === 'FREE' ? 'bg-info' : 'bg-warning'}">
                            ${chapter.accessType || 'FREE'}
                        </span>
                    </td>
                    <td>${chapter.coinPrice > 0 ? `${chapter.coinPrice} coin` : '-'}</td>
                    <td>${Utils.formatDate(chapter.createdAt)}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewChapter('${chapter.id}')" title="Xem">
                            <i class="bi bi-eye"></i>
                        </button>
                        <a href="/Stories/Details/${encodeURIComponent(chapter.storyId || '')}" class="btn btn-sm btn-primary" title="Xem Story">
                            <i class="bi bi-book"></i>
                        </a>
                    </td>
                </tr>
            `).join('');
        }

        function renderPagination() {
            const nav = document.getElementById('paginationNav');
            if (totalPages <= 1) {
                nav.innerHTML = '';
                return;
            }

            let pagination = '<ul class="pagination justify-content-center">';

            pagination += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadChapters(${currentPage - 1}); return false;">Trước</a>
            </li>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    pagination += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadChapters(${i}); return false;">${i}</a>
                    </li>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    pagination += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            pagination += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadChapters(${currentPage + 1}); return false;">Sau</a>
            </li>`;

            pagination += '</ul>';
            nav.innerHTML = pagination;
        }

        function viewChapter(id) {
            window.location.href = `/Chapters/Read/${encodeURIComponent(id)}`;
        }
    </script>
}